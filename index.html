function doGet() {
  const data = getMapData();
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function getMapData() {
  const ss = SpreadsheetApp.openById('1HBt9l7Z4Q4PekvNUrPd8tUopRy0JFO27epT-tgsxqU0');
  const sheets = ss.getSheets();
  const result = [];

  for (const sheet of sheets) {
    const values = sheet.getDataRange().getValues();
    const sheetName = sheet.getName();

    for (let i = 1; i < values.length; i++) {
      const row = values[i];

      const name = row[0];
      const lat = parseFloat(row[1]);
      const lng = parseFloat(row[2]);
      const pdf = row[3];
      const price = row[4];
      const tsubo = row[5];
      const agency = row[6];

      if (name && !isNaN(lat) && !isNaN(lng)) {
        result.push({
          name: name,
          lat: lat,
          lng: lng,
          pdf: pdf || '',
          sheet: sheetName,
          price: price || '',
          tsubo: tsubo || '',
          agency: agency || ''
        });
      }
    }
  }

  return result;
}
